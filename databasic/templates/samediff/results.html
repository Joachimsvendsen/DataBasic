{% extends "tool_base.html" %}
{% from 'macros.html' import download_url %}
{% macro sameness_table(filename, outer_loop, loop) -%}
	
	<div class="chart-container">
		<!-- Navigation -->
		<ul class="nav nav-tabs navbar-right" role="tablist">
			<li role="presentation" class="active">
				<a href="#{{loop.index-1}}-sameness-visual" aria-controls="visual" role="tab" data-toggle="tab">{{_("Visual")}}</a>
			</li>
			<li role="presentation">
				<a href="#{{loop.index-1}}-sameness-tabular" aria-controls="tabular" role="tab" data-toggle="tab">{{_("Tabular")}}</a>
			</li>
		</ul>

		<!-- Content -->
		<div class="tab-content content-top">
			<div role="tabpanel" class="tab-pane active" id="{{loop.index-1}}-sameness-visual">
				<div class="row">
					<div class="col-md-12">
						<div id="sameness{{loop.index-1}}Chart" class="sameness-chart"></div>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="{{loop.index-1}}-sameness-tabular">
				<table class="table">
					<thead>
						<tr>
							<th>{{_("Filename")}}</th>
							<th>{{_("Cosine Similarity")}}</th>
							<th>{{_("Words in Common")}}</th>
						</tr>
					</thead>
					{% set idx = 0 %}
					{% for cs in results['cosineSimilarity'][ outer_loop.index0 ] %}
						{% set idx = idx + 1 %}
						{% set csThisFile = cs[ outer_loop.index0 ] %}
						{% if results['filenames'][ loop.index0 ] != filename %}
						<tbody>
							<tr>
								<td>{{ results['filenames'][ loop.index0 ] }}</td>
								<td>{{'%0.2f'| format(cs|float)}} {{"(sort of similar)"}}</td>
								<td><a href="/{{g.current_lang}}/samediff/results/{{ filename }}-and-{{ results['filenames'][ loop.index0 ] }}-common-words?id={{ results['_id'] }}">View</a></td>
							</tr>
						</tbody>
						{% endif %}
					{% endfor %}
				</table>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro difference_table(outer_loop, loop) -%}
	
	<div class="chart-container">
		<!-- Navigation -->
		<ul class="nav nav-tabs navbar-right" role="tablist">
			<li role="presentation" class="active">
				<a href="#{{loop.index}}-diff-visual" aria-controls="visual" role="tab" data-toggle="tab">{{_("Visual")}}</a>
			</li>
			<li role="presentation">
				<a href="#{{loop.index}}-diff-tabular" aria-controls="tabular" role="tab" data-toggle="tab">{{_("Tabular")}}</a>
			</li>
		</ul>

		<!-- Content -->
		<div class="tab-content content-top">
			<div role="tabpanel" class="tab-pane active" id="{{loop.index}}-diff-visual">
				<div class="row">
					<div class="col-md-12">
						<div id="diff{{loop.index-1}}Chart" class="diff-chart"></div>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="{{loop.index}}-diff-tabular">
				<table class="table">
					<thead>
						<tr>
							<th>{{_("Word")}}</th>
							<th>{{_("TF-IDF")}}</th>
							<th>{{_("Frequency")}} </th>
						</tr>
					</thead>
					{% for row in results['tfidf'][loop.index-1] | batch(10) | first %}
					<tbody>
						<tr>
							<td>{{ row['term'] }}</td>
							<td>{{ '%0.2f'| format(row['tfidf']|float) }}</td>
							<td>{{ row['frequency'] }}</td>
						</tr>
					</tbody>
					{% endfor %}
				</table>
			</div>
		</div>
	</div>
{%- endmacro %}

{% block title %}{{ _('SameDiff results') }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/samediff-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<div class="container">
	<div class="row" >
		<div class="col-md-12 text-center">
			<h3>{{_("Your SameDiff Report")}}</h3>
			{{ what_next_anchor() }}
		</div>
	</div>
	{% if results['status'] != 'complete' %}
		<div class="row">
			<div class="col-md-12">
				<h1>{{ _('Your results are being processed. We\'ll send you an email when they\'re ready, at which point you can reload this page to see them.') }}</h1>
				<h2>{{ _('Your email will arrive to:') }} {{ results['email'] }} </h2>
				
			</div>
		</div>
	{% else %}

		<div class="row">
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][0]) }}</h4>
				<div class="left-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that are the same in "%(doc1)s" and "%(doc2)s"', doc1=results['filenames'][0], doc2=results['filenames'][1]) }}</h4>
				<div class="center-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][1]) }}</h4>
				<div class="right-cloud"></div>
			</div>
		</div>

		{# <!-- High level summary -->
		<div class="row">
			<div class="col-md-12">
				<p>
					{% if 'humanReadableSimilarity' in results %}
						These two documents are {{ results['humanReadableSimilarity'] }}.
					{% endif %}
					{% if 'mostDifferentFile' in results %}
						The most different file is <em>{{ results['mostDifferentFile'] }}</em>.
					{% endif %}
					{% if 'mostSimilar' in results %}
						The most similar two files are <em>{{results['mostSimilar'][0]}}</em> and <em>{{results['mostSimilar'][1] }}</em>.
						The most different two files are <em>{{results['mostDifferent'][0]}}</em> and <em>{{results['mostDifferent'][1]}}</em>.
					{% endif %}
				</p>
			</div>
		</div>

		{% for filename in results['filenames'] %}
			{% set outer_loop = loop %}
			<div class="row">
				<div class="col-md-12">
					<h3><span class="glyphicon glyphicon-file" aria-hidden="true"></span> {{ filename }}</h3>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h4>{{_("Sameness")}}</h4>
					<p class="table-info">{{_("This chart shows you how similar this document is to the others you uploaded. The numbers are each document's 'cosine similarity' score.")}}</p>
					{{ sameness_table(filename, outer_loop, loop) }}
				</div>
				<div class="col-md-6">
					<h4>{{_("Difference")}}</h4>
					<p class="table-info">{{_("This table shows you the words that make this document different from the others.")}} [<a href={{ download_url(tool_name, results['_id'], 'csv', 'tfidf', filename) }}>download</a>]</p>
					{{ difference_table(outer_loop, loop) }}
				</div>
			</div>
		{% endfor %} #}
	{% endif %}
	{{ what_next() }}
</div>
{% endblock %}

{% block results_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/lib/d3.layout.cloud.js" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/underscore.min.js') }}"></script>
<script type="text/javascript" src="/static/js/samediff.js" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
{% if results %}
	{% if results['status'] == 'complete' %}
		{#$(function(){
		  {% for idx in range(0,results['filenames']|length) %}
		    dataset{{idx}} = {{results['similarityLists'][idx] | tojson}};
		    renderSimilarityChart('#sameness{{idx}}Chart',dataset{{idx}});
		    console.log(dataset{{idx}});
		  {% endfor %}
		  maxDiffScore = {{maxTfIdfScore}};
		  {% for idx in range(0,results['filenames']|length) %}
		    diffWords{{idx}} = [
		    {% for row in results['tfidf'][idx] | batch(50) | first %}
		      { text: "{{row['term']|safe}}", score: {{'%0.2f'| format(row['tfidf']|float)}} },
		    {% endfor %}
		    ];
		    renderDiffWordCloud('#diff{{idx}}Chart', diffWords{{idx}});
		  {% endfor %}
		});#}

	$(function() {
		var data;

		data = [
			{% for w in results['diffWordsDoc1']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['freq']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.left-cloud');

		data = [
			{% for w in results['sameWords']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['total']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.center-cloud');

		data = [
			{% for w in results['diffWordsDoc2']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['freq']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.right-cloud');
	});

	function renderWordCloud(wordcounts, containerClass) {

		var padding = 10;
		var height = 300;
		var sizeRange = { min: 10, max: 24 }

		var container = d3.select(containerClass);
		var width = $(containerClass).width();
		var svg = container.append('svg')
			.attr('height', height)
			.attr('width', width);
		var group = svg.append('g').classed('group', true)
		    .attr('transform', 'translate(0,' + padding + ')');
		var y = height;
		var words;

		var countSel = function (d) { return d.count };
		var sum = d3.sum(wordcounts, countSel);
		var top = _.first(wordcounts, 100);
		_.each(top, function (d) {
			d.tfnorm = d.count / sum;
		});

		var terms = {}
		_.each(top, function (d) {
			terms[d.word] = d;
		});

		var fullExtent = d3.extent(wordcounts, function (d) { return d.tfnorm; });
		var stems = _.filter(terms, function (d) { return d; });

		var counter = wordcounts.length;
		while (y >= height && counter > 0) {
			if (stems.length > 0) {
				words = group.selectAll('.word')
					.data(stems, function (d) { return d.word; });
				words.enter()
					.append('text').classed('word', true);
				words
					.attr('font-size', function (d) {
						return fontSize(d, fullExtent, sizeRange) + 'px';
					});
			}
			d3.selectAll('.word')
	            .text(function (d) { return d.word; })
	            .attr('font-weight', 'bold')
	            .attr('fill', '#fff');
			y = 0;
			height = listCloudLayout(words, width, fullExtent, sizeRange, padding);
			y = Math.max(y, height);
			counter --;
		}
	}

	function fontSize (term, extent, sizeRange) {
        var size = sizeRange.min
            + (sizeRange.max - sizeRange.min)
                * ( Math.log(term.tfnorm) - Math.log(extent[0]) ) / ( Math.log(extent[1]) - Math.log(extent[0]) );
        return size;
    }

    function listCloudLayout (words, width, extent, sizeRange, padding) {
        var x = 0;
        if (typeof(words) === 'undefined') {
            return 0;
        }
        words.attr('x', function (d) {
            var textLength = this.getComputedTextLength();
            var fs = fontSize(d, extent, sizeRange);
            var lastX = x;
            if (x + textLength + padding > width) {
                lastX = 0;
            }
            x = lastX + textLength + 0.3*fs;
            return lastX;
        });
        var y = -0.5 * sizeRange.max;
        var lastAdded = 0;
        words.attr('y', function (d) {
            if (d3.select(this).attr('x') == 0) {
                y += 1.5 * fontSize(d, extent, sizeRange);
                lastAdded = 1.5 * fontSize(d, extent, sizeRange);
            }
            return y;
        });
        return y + lastAdded;
    }
	{% endif %}
{% endif %}
</script>
{% endblock %}