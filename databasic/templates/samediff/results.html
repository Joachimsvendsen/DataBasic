{% extends "tool_base.html" %}
{% from 'macros.html' import download_url %}
{% macro sameness_table(filename, outer_loop, loop) -%}
	
	<div class="chart-container">
		<!-- Navigation -->
		<ul class="nav nav-tabs navbar-right" role="tablist">
			<li role="presentation" class="active">
				<a href="#{{loop.index-1}}-sameness-visual" aria-controls="visual" role="tab" data-toggle="tab">{{_("Visual")}}</a>
			</li>
			<li role="presentation">
				<a href="#{{loop.index-1}}-sameness-tabular" aria-controls="tabular" role="tab" data-toggle="tab">{{_("Tabular")}}</a>
			</li>
		</ul>

		<!-- Content -->
		<div class="tab-content content-top">
			<div role="tabpanel" class="tab-pane active" id="{{loop.index-1}}-sameness-visual">
				<div class="row">
					<div class="col-md-12">
						<div id="sameness{{loop.index-1}}Chart" class="sameness-chart"></div>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="{{loop.index-1}}-sameness-tabular">
				<table class="table">
					<thead>
						<tr>
							<th>{{_("Filename")}}</th>
							<th>{{_("Cosine Similarity")}}</th>
							<th>{{_("Words in Common")}}</th>
						</tr>
					</thead>
					{% set idx = 0 %}
					{% for cs in results['cosineSimilarity'][ outer_loop.index0 ] %}
						{% set idx = idx + 1 %}
						{% set csThisFile = cs[ outer_loop.index0 ] %}
						{% if results['filenames'][ loop.index0 ] != filename %}
						<tbody>
							<tr>
								<td>{{ results['filenames'][ loop.index0 ] }}</td>
								<td>{{'%0.2f'| format(cs|float)}} {{"(sort of similar)"}}</td>
								<td><a href="/{{g.current_lang}}/samediff/results/{{ filename }}-and-{{ results['filenames'][ loop.index0 ] }}-common-words?id={{ results['_id'] }}">View</a></td>
							</tr>
						</tbody>
						{% endif %}
					{% endfor %}
				</table>
			</div>
		</div>
	</div>
{%- endmacro %}

{% macro difference_table(outer_loop, loop) -%}
	
	<div class="chart-container">
		<!-- Navigation -->
		<ul class="nav nav-tabs navbar-right" role="tablist">
			<li role="presentation" class="active">
				<a href="#{{loop.index}}-diff-visual" aria-controls="visual" role="tab" data-toggle="tab">{{_("Visual")}}</a>
			</li>
			<li role="presentation">
				<a href="#{{loop.index}}-diff-tabular" aria-controls="tabular" role="tab" data-toggle="tab">{{_("Tabular")}}</a>
			</li>
		</ul>

		<!-- Content -->
		<div class="tab-content content-top">
			<div role="tabpanel" class="tab-pane active" id="{{loop.index}}-diff-visual">
				<div class="row">
					<div class="col-md-12">
						<div id="diff{{loop.index-1}}Chart" class="diff-chart"></div>
					</div>
				</div>
			</div>
			<div role="tabpanel" class="tab-pane" id="{{loop.index}}-diff-tabular">
				<table class="table">
					<thead>
						<tr>
							<th>{{_("Word")}}</th>
							<th>{{_("TF-IDF")}}</th>
							<th>{{_("Frequency")}} </th>
						</tr>
					</thead>
					{% for row in results['tfidf'][loop.index-1] | batch(10) | first %}
					<tbody>
						<tr>
							<td>{{ row['term'] }}</td>
							<td>{{ '%0.2f'| format(row['tfidf']|float) }}</td>
							<td>{{ row['frequency'] }}</td>
						</tr>
					</tbody>
					{% endfor %}
				</table>
			</div>
		</div>
	</div>
{%- endmacro %}

{% block title %}{{ _('SameDiff results') }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/samediff-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<div class="container">
	<div class="row" >
		<div class="col-md-12 text-center">
			<h3>{{_("Your SameDiff Report")}}</h3>
			{{ what_next_anchor() }}
		</div>
	</div>
	{% if results['status'] != 'complete' %}
		<div class="row">
			<div class="col-md-12">
				<h1>{{ _('Your results are being processed. We\'ll send you an email when they\'re ready, at which point you can reload this page to see them.') }}</h1>
				<h2>{{ _('Your email will arrive to:') }} {{ results['email'] }} </h2>
				
			</div>
		</div>
	{% else %}

		<div class="row">
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][0]) }}</h4>
				<div class="left-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that are the same in "%(doc1)s" and "%(doc2)s"', doc1=results['filenames'][0], doc2=results['filenames'][1]) }}</h4>
				<div class="center-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][1]) }}</h4>
				<div class="right-cloud"></div>
			</div>
		</div>

		{# <!-- High level summary -->
		<div class="row">
			<div class="col-md-12">
				<p>
					{% if 'humanReadableSimilarity' in results %}
						These two documents are {{ results['humanReadableSimilarity'] }}.
					{% endif %}
					{% if 'mostDifferentFile' in results %}
						The most different file is <em>{{ results['mostDifferentFile'] }}</em>.
					{% endif %}
					{% if 'mostSimilar' in results %}
						The most similar two files are <em>{{results['mostSimilar'][0]}}</em> and <em>{{results['mostSimilar'][1] }}</em>.
						The most different two files are <em>{{results['mostDifferent'][0]}}</em> and <em>{{results['mostDifferent'][1]}}</em>.
					{% endif %}
				</p>
			</div>
		</div>

		{% for filename in results['filenames'] %}
			{% set outer_loop = loop %}
			<div class="row">
				<div class="col-md-12">
					<h3><span class="glyphicon glyphicon-file" aria-hidden="true"></span> {{ filename }}</h3>
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<h4>{{_("Sameness")}}</h4>
					<p class="table-info">{{_("This chart shows you how similar this document is to the others you uploaded. The numbers are each document's 'cosine similarity' score.")}}</p>
					{{ sameness_table(filename, outer_loop, loop) }}
				</div>
				<div class="col-md-6">
					<h4>{{_("Difference")}}</h4>
					<p class="table-info">{{_("This table shows you the words that make this document different from the others.")}} [<a href={{ download_url(tool_name, results['_id'], 'csv', 'tfidf', filename) }}>download</a>]</p>
					{{ difference_table(outer_loop, loop) }}
				</div>
			</div>
		{% endfor %} #}
	{% endif %}
	{{ what_next() }}
</div>
{% endblock %}

{% block results_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/lib/d3.layout.cloud.js" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/underscore.min.js') }}"></script>
<script type="text/javascript" src="/static/js/samediff.js" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
{% if results %}
	{% if results['status'] == 'complete' %}
		{#$(function(){
		  {% for idx in range(0,results['filenames']|length) %}
		    dataset{{idx}} = {{results['similarityLists'][idx] | tojson}};
		    renderSimilarityChart('#sameness{{idx}}Chart',dataset{{idx}});
		    console.log(dataset{{idx}});
		  {% endfor %}
		  maxDiffScore = {{maxTfIdfScore}};
		  {% for idx in range(0,results['filenames']|length) %}
		    diffWords{{idx}} = [
		    {% for row in results['tfidf'][idx] | batch(50) | first %}
		      { text: "{{row['term']|safe}}", score: {{'%0.2f'| format(row['tfidf']|float)}} },
		    {% endfor %}
		    ];
		    renderDiffWordCloud('#diff{{idx}}Chart', diffWords{{idx}});
		  {% endfor %}
		});#}

	$(function() {
		renderWordCloud('.left-cloud');
	});

	function renderWordCloud(containerClass) {

		var padding = 10;
		var height = 400;
		var sizeRange = { min: 10, max: 24 }

		var that = this;
		var container = d3.select(containerClass);
		var width = this.$(containerClass).width();
		var innerWidth = (width - 8*padding)/3.0;
		var svg = container.append('svg')
			.attr('height', height)
			.attr('width', width);
		var group = svg.append('g').classed('group', true);
		var y = height;
		var words;
		var wordListHeight = height - 2*padding;

		// data
		var wordcounts = [
			{
				'stem': 'test',
				'term': 'test',
				'count': 3
			},
			{
				'stem': 'test2',
				'term': 'test2',
				'count': 1
			}
		];
		var countSel = function (d) { return d.count };
		var sum = d3.sum(wordcounts, countSel);
		var top = _.first(wordcounts, 100);
		_.each(top, function (d) {
			d.tfnorm = d.count / sum;
		});

		var terms = {}
		_.each(top, function (d) {
			terms[d.stem] = d;
		});

		var stems = _.filter(terms, function (d) { return d; });

		while (y >= wordListHeight && sizeRange.max > sizeRange.min) {
			if (stems.length > 0) {
				words = group.selectAll('.word')
					.data(stems, function (d) { return d.stem; });
				words.enter()
					.append('text').classed('word', true);
				words
					.attr('font-size', function (d) {
						return 20;
						//return that.fontSize(d, d3.extent(this.all, function (d) { return d.tfnorm }), sizeRange);
					});
			}
			d3.selectAll('.word')
	            .text(function (d) { return d.term; })
	            .attr('font-weight', 'bold')
	            .attr('fill', '#000');
			sizeRange.max = sizeRange.max - 1;
		}
	}

	function fontSize (term, extent, sizeRange) {
		console.log(term);
        var size = sizeRange.min
            + (sizeRange.max - sizeRange.min)
                * ( Math.log(term.tfnorm) - Math.log(extent[0]) ) / ( Math.log(extent[1]) - Math.log(extent[0]) );
        return size;
    }

    {# reference
	function renderSvg () {
	        var that = this;
	        var container = d3.select(this.el).select('.content-viz');
	        var width = this.$('.content-viz').width();
	        var innerWidth = (width - 8*this.config.padding)/3.0;
	        var svg = container.append('svg')
	            .attr('height', this.config.height)
	            .attr('width', width);
	        var leftGroup = svg.append('g').classed('left-group', true)
	            .attr('transform', 'translate('+2*this.config.padding+')');
	        var intersectGroup = svg.append('g').classed('intersect-group', true)
	            .attr('transform', 'translate('+(innerWidth+4*this.config.padding)+')');
	        var rightGroup = svg.append('g').classed('right-group', true)
	            .attr('transform', 'translate('+(2.0*innerWidth+6*this.config.padding)+')');
	        var y = this.config.height;
	        var sizeRange = this.sizeRange();
	        var leftWords, rightWords, intersectWords;
	        var label = intersectGroup.append('text')
	            .text('Both')
	            .attr('font-size', this.config.labelSize)
	            .attr('font-weight', 'bold')
	            .attr('text-anchor', 'middle')
	            .attr('x', innerWidth/2.0 + this.config.labelSize/2.0)
	            .attr('y', this.config.padding + this.config.labelSize);
	        var legendXoff = -this.config.labelSize/2.0 - label[0][0].getBBox().width/2.0;
	        var legendYoff = (1 + 0.25)*this.config.labelSize/2.0
	        intersectGroup.append('circle')
	            .attr('r', 0.7*this.config.labelSize/2.0)
	            .attr('cy', this.config.padding + legendYoff)
	            .attr('cx', innerWidth/2.0 + legendXoff)
	            .attr('fill', '#000000');
	        label = leftGroup.append('text')
	            .text(this.collection.at(this.leftQuery).getName())
	            .attr('font-size', this.config.labelSize)
	            .attr('font-weight', 'bold')
	            .attr('text-anchor', 'middle')
	            .attr('x', innerWidth/2.0 + this.config.labelSize/2.0)
	            .attr('y', this.config.padding + this.config.labelSize);
	        var legendXoff = -this.config.labelSize/2.0 - label[0][0].getBBox().width/2.0;
	        var legendYoff = (1 + 0.25)*this.config.labelSize/2.0
	        leftGroup.append('circle')
	            .attr('r', 0.7*this.config.labelSize/2.0)
	            .attr('cy', this.config.padding + legendYoff)
	            .attr('cx', innerWidth/2.0 + legendXoff)
	            .attr('fill', this.leftModel.getColor());
	        var label = rightGroup.append('text')
	            .text(this.collection.at(this.rightQuery).getName())
	            .attr('font-size', this.config.labelSize)
	            .attr('font-weight', 'bold')
	            .attr('text-anchor', 'middle')
	            .attr('x', innerWidth/2.0 + this.config.labelSize/2.0)
	            .attr('y', this.config.padding + this.config.labelSize);
	        var legendXoff = -this.config.labelSize/2.0 - label[0][0].getBBox().width/2.0;
	        var legendYoff = (1 + 0.25)*this.config.labelSize/2.0
	        rightGroup.append('circle')
	            .attr('r', 0.7*this.config.labelSize/2.0)
	            .attr('cy', this.config.padding + legendYoff)
	            .attr('cx', innerWidth/2.0 + legendXoff)
	            .attr('fill', this.rightModel.getColor());
	        var wordListHeight = this.config.height - 1.5*this.config.labelSize - 2*this.config.padding;
	        var intersectList = intersectGroup.append('g')
	            .attr('transform', 'translate(0,' + (2*this.config.labelSize) + ')');
	        var leftList = leftGroup.append('g')
	            .attr('transform', 'translate(0,' + (2*this.config.labelSize) + ')');
	        var rightList = rightGroup.append('g')
	            .attr('transform', 'translate(0,' + (2*this.config.labelSize) + ')');
	        while (y >= wordListHeight && sizeRange.max > sizeRange.min) {
	            // Create words
	            if (this.left.length > 0) {
	                leftWords = leftList.selectAll('.word')
	                    .data(this.left, function (d) { return d.stem; });
	                leftWords.enter()
	                    .append('text').classed('word', true).classed('left', true);
	                leftWords
	                    .attr('font-size', function (d) {
	                        return that.fontSize(d, that.fullExtent, sizeRange); });
	            }
	            if (this.right.length > 0) {
	                rightWords = rightList.selectAll('.word')
	                    .data(this.right, function (d) { return d.stem; });
	                rightWords.enter()
	                    .append('text').classed('word', true).classed('right', true);
	                rightWords
	                    .attr('font-size', function (d) {
	                        return that.fontSize(d, that.fullExtent, sizeRange); });
	            }
	            if (this.center.length > 0) {
	                intersectWords = intersectList.selectAll('.word')
	                    .data(this.center, function (d) { return d.stem; });
	                intersectWords.enter()
	                    .append('text').classed('word', true).classed('intersect', true);
	                intersectWords
	                    .attr('font-size', function (d) {
	                        return that.fontSize(d, that.fullExtent, sizeRange); });
	            }
	            d3.selectAll('.word')
	                .text(function (d) { return d.term; })
	                .attr('font-weight', 'bold');
	            d3.selectAll('.left.word')
	                .attr('fill', this.leftModel.getColor());
	            d3.selectAll('.right.word')
	                .attr('fill', this.rightModel.getColor());
	            // Layout
	            y = 0;
	            leftHeight = this.listCloudLayout(leftWords, innerWidth, this.fullExtent, sizeRange);
	            intersectHeight = this.listCloudLayout(intersectWords, innerWidth, this.fullExtent, sizeRange);
	            rightHeight = this.listCloudLayout(rightWords, innerWidth, this.fullExtent, sizeRange);
	            y = Math.max(y, leftHeight);
	            y = Math.max(y, intersectHeight);
	            y = Math.max(y, rightHeight);
	            sizeRange.max = sizeRange.max - 1;
	        }
	        if (y < this.config.height) {
	            svg.attr('height', y + 2*this.config.labelSize);
	        }
	    }#}
	{% endif %}
{% endif %}
</script>
{% endblock %}