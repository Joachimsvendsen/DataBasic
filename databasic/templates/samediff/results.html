{% extends "tool_base.html" %}
{% from 'macros.html' import download_url %}

{% block title %}{{ _('SameDiff results') }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/samediff-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<div class="container">
	<div class="row" >
		<div class="col-md-12 text-center" id="title">
			<h2>{{_("Your SameDiff Report")}}</h2>
			{% if 'complete' in results['status'] %}
			<h4>
				{% set cosine_sim = results['cosineSimilarity'][0][1]|float %}
				{% if cosine_sim < 0.33 %}
					{{ _('These texts are very different.') }}
				{% elif cosine_sim > 0.67 %}
					{{ _('These texts are similar.') }}
				{% else %}
					{{ _('These texts are sort of similar.') }}
				{% endif %}
			</h4>
			{% endif %}
		</div>
	</div>
	{% if results['status'] != 'complete' %}
		<div class="row">
			<div class="col-md-12">
				<h1>{{ _('Your results are being processed. We\'ll send you an email when they\'re ready, at which point you can reload this page to see them.') }}</h1>
				<h2>{{ _('Your email will arrive to:') }} {{ results['email'] }} </h2>
			</div>
		</div>
	{% else %}

		<div class="row" id="word-clouds">
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][0]) }}</h4>
				<div class="left-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that are the same in "%(doc1)s" and "%(doc2)s"', doc1=results['filenames'][0], doc2=results['filenames'][1]) }}</h4>
				<div class="center-cloud"></div>
			</div>
			<div class="col-md-4">
				<h4>{{ _('Words that make "%(document)s" different', document=results['filenames'][1]) }}</h4>
				<div class="right-cloud"></div>
			</div>
		</div>
	{% endif %}
</div>
<div class="container-fluid">
	{{ what_next() }}
</div>
{% endblock %}

{% block results_scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="/static/js/lib/d3.layout.cloud.js" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/underscore.min.js') }}"></script>
<script type="text/javascript" src="/static/js/samediff.js" charset="utf-8"></script>
<script type="text/javascript" charset="utf-8">
{% if results %}
	{% if results['status'] == 'complete' %}
		{#$(function(){
		  {% for idx in range(0,results['filenames']|length) %}
		    dataset{{idx}} = {{results['similarityLists'][idx] | tojson}};
		    renderSimilarityChart('#sameness{{idx}}Chart',dataset{{idx}});
		    console.log(dataset{{idx}});
		  {% endfor %}
		  maxDiffScore = {{maxTfIdfScore}};
		  {% for idx in range(0,results['filenames']|length) %}
		    diffWords{{idx}} = [
		    {% for row in results['tfidf'][idx] | batch(50) | first %}
		      { text: "{{row['term']|safe}}", score: {{'%0.2f'| format(row['tfidf']|float)}} },
		    {% endfor %}
		    ];
		    renderDiffWordCloud('#diff{{idx}}Chart', diffWords{{idx}});
		  {% endfor %}
		});#}

	$(function() {
		var data;

		data = [
			{% for w in results['diffWordsDoc1']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['freq']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.left-cloud');

		data = [
			{% for w in results['sameWords']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['total']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.center-cloud');

		data = [
			{% for w in results['diffWordsDoc2']|batch(75)|first %}
				{ word: "{{ w['term']|safe }}", count: {{ w['freq']|float }} },
			{% endfor %}
		];
		renderWordCloud(data, '.right-cloud');
	});

	function renderWordCloud(wordcounts, containerClass) {

		var padding = 10;
		var height = 300;
		var sizeRange = { min: 10, max: 24 }

		var container = d3.select(containerClass);
		var width = $(containerClass).width();
		var svg = container.append('svg')
			.attr('height', height)
			.attr('width', width);
		var group = svg.append('g').classed('group', true)
		    .attr('transform', 'translate(0,' + padding + ')');
		var y = height;
		var words;

		var countSel = function (d) { return d.count };
		var sum = d3.sum(wordcounts, countSel);
		var top = _.first(wordcounts, 100);
		_.each(top, function (d) {
			d.tfnorm = d.count / sum;
		});

		var terms = {}
		_.each(top, function (d) {
			terms[d.word] = d;
		});

		var fullExtent = d3.extent(wordcounts, function (d) { return d.tfnorm; });
		var stems = _.filter(terms, function (d) { return d; });

		var counter = wordcounts.length;
		while (y >= height && counter > 0) {
			if (stems.length > 0) {
				words = group.selectAll('.word')
					.data(stems, function (d) { return d.word; });
				words.enter()
					.append('text').classed('word', true);
				words
					.attr('font-size', function (d) {
						return fontSize(d, fullExtent, sizeRange) + 'px';
					});
			}
			d3.selectAll('.word')
	            .text(function (d) { return d.word; })
	            .attr('font-weight', 'bold')
	            .attr('fill', '#fff');
			y = 0;
			height = listCloudLayout(words, width, fullExtent, sizeRange, padding);
			y = Math.max(y, height);
			counter --;
		}
	}

	function fontSize (term, extent, sizeRange) {
        var size = sizeRange.min
            + (sizeRange.max - sizeRange.min)
                * ( Math.log(term.tfnorm) - Math.log(extent[0]) ) / ( Math.log(extent[1]) - Math.log(extent[0]) );
        return size;
    }

    function listCloudLayout (words, width, extent, sizeRange, padding) {
        var x = 0;
        if (typeof(words) === 'undefined') {
            return 0;
        }
        words.attr('x', function (d) {
            var textLength = this.getComputedTextLength();
            var fs = fontSize(d, extent, sizeRange);
            var lastX = x;
            if (x + textLength + padding > width) {
                lastX = 0;
            }
            x = lastX + textLength + 0.3*fs;
            return lastX;
        });
        var y = -0.5 * sizeRange.max;
        var lastAdded = 0;
        words.attr('y', function (d) {
            if (d3.select(this).attr('x') == 0) {
                y += 1.5 * fontSize(d, extent, sizeRange);
                lastAdded = 1.5 * fontSize(d, extent, sizeRange);
            }
            return y;
        });
        return y + lastAdded;
    }
	{% endif %}
{% endif %}
</script>
{% endblock %}