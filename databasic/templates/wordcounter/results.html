{% extends "tool_base.html" %}
{% from 'macros.html' import hover_tooltip, download_url %}

{% block title %}{{ _('Word-Counter results') }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/wordcounter-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-12">
			<div class="top-info">
				<h3>{{ title }}</h3>
				<p>{{ _('Here is a picture of the words used most often in your the document. Words used more often are bigger, and ones used less often are smaller. This picture, called a "word cloud", is helpful to get a sense of the most used words in a document.') }}</p>
			</div>
			<div class="word-cloud">
				
			</div>
		</div>
	</div>

	<div class="row" id="frequencies">
		<div class="col-sm-4">
			<h2>{{ _('Top Words') }} 
			<a href="/{{ g['current_lang'] }}/wordcounter/results/download/{{ csv_files[0] }}"><span class="glyphicon glyphicon-download" aria-hidden="true"></span></a></h2>
			<table class="table">
				<thead>
					<tr><th>{{ _('Word') }}</th><th>{{ _('Frequency') }}</th></tr>
				</thead>
				<tbody>
					{% for word in results[0] %}
					<tr>
						<td>{{ word[0] }}</td>
						<td>{{ word[1] }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="col-sm-4">
			<h2>{{ _('%(bigrams)s', bigrams=hover_tooltip('Bigrams', 'A bigram is a two word phrase')) }} <a href="/{{ g['current_lang'] }}/wordcounter/results/download/{{ csv_files[1] }}"><span class="glyphicon glyphicon-download" aria-hidden="true"></span></a></h2>
			<table class="table">
				<thead>
					<tr><th>{{ _('%(bigram)s', bigram=hover_tooltip('Bigram', 'A bigram is a two word phrase')) }}</th><th>{{ _('Frequency') }}</th></tr>
				</thead>
				<tbody>
					{% for word in results[1] %}
					<tr>
						<td>{{ " ".join(word[0]) }}</td>
						<td>{{ word[1] }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
		<div class="col-sm-4">
			<h2>{{ _('%(trigrams)s', trigrams=hover_tooltip('Trigrams', 'A trigram is a three word phrase')) }} <a href="/{{ g['current_lang'] }}/wordcounter/results/download/{{ csv_files[2] }}"><span class="glyphicon glyphicon-download" aria-hidden="true"></span></a></h2>
			<table class="table">
				<thead>
					<tr><th>{{ _('%(trigram)s', trigram=hover_tooltip('Trigram', 'A trigram is a three word phrase')) }}</th><th>{{ _('Frequency') }}</th></tr>
				</thead>
				<tbody>
					{% for word in results[2] %}
					<tr>
						<td>{{ " ".join(word[0]) }}</td>
						<td>{{ word[1] }}</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>
	</div>
</div>
{% endblock %}

{% block results_scripts %}
	<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
	<script type="text/javascript" src="/static/js/lib/d3.layout.cloud.js" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">
		diffWordCloudDestination = null;

		function renderDiffWordCloud(elementSelector, dataset){
		  var w = 600;
		  var h = 400;
		  var maxScore = Math.max.apply(Math,dataset.map(function(o){return o.score;}))
		  var fontSizeScale = d3.scale.linear()
		      .domain([0, maxScore])
		      .range([10, 70]); 
		  console.log("renderDiffChart to "+elementSelector);
		  diffWordCloudDestination = elementSelector;
		  var layout =  d3.layout.cloud()
		    .size([w, h])
		    .words(dataset)
		    .padding(5)
		    .rotate(0)
		    .fontSize(function(d) { return fontSizeScale(d.score); })
		    .on("end", drawDiffWordCloud);
		  layout.start();
		}

		function drawDiffWordCloud(words) {
		  var w = 600;
		  var h = 400;
		  console.log("drawDiffWordCloud to "+diffWordCloudDestination);
		  d3.select(diffWordCloudDestination).append("svg")
		      .attr("width", w)
		      .attr("height", h)
		    .append("g")
		      .attr("transform", "translate(" + w/2 + "," + h/2 + ")")
		    .selectAll("text")
		      .data(words)
		    .enter().append("text")
		      .style("font-size", function(d) { return d.size + "px"; })
		      .attr("text-anchor", "middle")
		      .attr("transform", function(d) {
		        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
		      })
		      .text(function(d) { return d.text; });
		}

		$(function() {
			var data = [
				{% for word in results[0] | batch(50) | first %}
					{ text: "{{ word[0] }}".replace("&#39;", "'"), score: {{ word[1] }} },
				{% endfor %}
			];
			renderDiffWordCloud('.word-cloud', data);
		});
	</script>
{% endblock %}