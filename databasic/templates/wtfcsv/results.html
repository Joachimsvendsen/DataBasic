{% extends "tool_base.html" %}
{% from 'macros.html' import share, hover_tooltip %}
{% from 'tool_footer.html' import what_next %}

{% macro card_top(type_name, name, glyphicon) -%}
<div class="card-top">
	<h3 class="data-type"><i class="fa 
	{% if type_name == 'unicode' %}
		fa-font
	{% elif type_name == 'float' or type_name == 'int' or type_name == 'long' or type_name == 'complex' %}
		fa-hashtag
	{% elif type_name == 'datetime' %}
		fa-calendar
	{% elif type_name == 'date' %}
		fa-calendar
	{% elif type_name == 'time' %}
		fa-clock-o
	{% elif type_name == 'bool' %}
		fa-question-circle
	{% else %}
		fa-database
	{% endif %}
	"></i></h3>
	<h3 class="dragHandle">{{ name }}</h3>
	<div class="close-button"><h3><span class="glyphicon {{ glyphicon }}" aria-hidden="true"></span></h3></div>
</div>
{%- endmacro %}

{% set column_count = results[index]['columns']|length %}

{% block title %}{{_("WTFcsv: ")}} {{ results[index]['filename'] }}{% endblock %}

{% block custom_css %}
	<link href="{{ url_for('static', filename='css/wtfcsv-results.scss.css') }}" rel="stylesheet" type="text/css">
{% endblock %}

{% block nav %}
	{% include 'tool_nav.html' %}
{% endblock %}

{% block body %}
<header>
	<div class="container-fluid">
		{% if results|length > 1 %}
		<div class="row centered-row">
	        <div class="col-md-12">
				<ul class="nav nav-tabs nav-justified">
				{% for r in range(results|length) %}
					<li role="presentation" {% if r == index %}class="active"{% endif %}>
						<a href="{{ request.url.replace('/results/' + index|string, '/results/' + r|string) }}">{{ results[r]['sheet_name'] }}</a>
					</li>
				{% endfor %}
				</ul>
			</div>
		</div>
		{% endif %}

		<div class="row">
			<div class="col-md-12" id="intro">
				<h2 class="summary">
					{{_("WTFcsv: ")}} {{ results[index]['filename'] }} 
				</h2>
				<h3 class="summary">
					{{ _("%(rows)s rows of data grouped into %(cols)s columns.",
					rows=results[index]['row_count'],
					cols=results[index]['columns']|length) }}
				</h3>
				<h3 class="summary">
					{{_("Here's some %(metadata)s about each column.", 
					metadata=hover_tooltip('metadata', 'Metadata summarizes basic information about data to make it easier to discover what\'s going on'))}}
				</h3>
				{{ what_next_anchor() }}
			</div>
		</div>
	</div>
</header>

<div class="container-fluid" id="cards">
	<div class="list-group" id="sortableRow">
	{% for c in range(column_count) %}
		
		{% set col=results[index]['columns'][c] %}
		{% set type_name=col['type'] %}
		{% set is_number = 'numbers' in col['display_type_name'] %}
		
		<div class="col-sm-6 col-md-4 list-group-item" id="col-card-{{ c }}">
			<div class="column-info">
				<div class="card" id="card-{{ c }}">
					<div class="front">
						<div class="card-content">
							{{ card_top(type_name, col['name'], 'glyphicon-info-sign') }}
							<div id="card-chart-{{ c }}"></div>
						</div>
					</div>
					<div class="back">
						<div class="card-content">
							{{ card_top(type_name, col['name'], 'glyphicon-signal') }}
							<div class="card-bottom">
								<ul>
									<li>{{_("This column is full of")}} {{ col['display_type_name'] }}</li>
									{% if 'values' in col %}
										<li>{{_("The unique values in this column are:")}}
										<ul>
											{% for val in col['values'] %}<li><em>{{val}}</em></li>{% endfor %}
										</ul>
										</li>
									{% elif 'most_freq_values' in col %}
										<li>{{ _("The most frequent values in this column are:") }}
											<ul>
												{% for val in col['most_freq_values'] %}
													{% if is_number %}
													<li><em>{{ val['value'] | replace("_", ".") }}</em><em> ({{ val['count'] }})</em></li>
													{% else %}
														<li><em>{{ val['value'] }}</em><em> ({{ val['count'] }})</em></li>
													{% endif %}
												{% endfor %}
											</ul>
										</li>
									{% endif %}
									{% if 'max_str_len' in col %}
										<li>{{ _("The longest string has %d characters" % col['max_str_len']) }}</li>
									{% endif %}
									{% if 'min' in col %}
										<li>
										{% if type_name == 'datetime' or type_name == 'date' %}
											{{ _('The earliest date is') }}
										{% elif type_name == 'time' %}
											{{ _('The earliest time is') }}
										{% else %}
											{{_("The smallest number is") }} 
										{% endif %} <em>{{col['min']}}</em></li>
									{% endif %}
									{% if 'max' in col %}
										<li>
										{% if type_name == 'datetime' or type_name == 'date' %}
											{{ _('The latest date is') }}
										{% elif type_name == 'time' %}
											{{ _('The latest time is') }}
										{% else %}
											{{_("The biggest number is") }}
										{% endif %} <em>{{col['max']}}</em></li>
									{% endif %}
									{% if 'sum' in col %}
										<li>{{_("The total is") }} <em>{{col['sum']|round(2)}}</em></li>
									{% endif %}
									{% if 'mean' in col %}
										<li>{{_("The average is") }} <em>{{col['mean']|round(2)}}</em></li>
									{% endif %}
									{% if 'median' in col %}
										<li>{{_("The median is") }} <em>{{col['median']|round(2)}}</em></li>
									{% endif %}
									{% if 'stdev' in col %}
										<li>{{_("The standard deviation is") }} <em>{{col['stdev']|round(2)}}</em></li>
									{% endif %}
									{% if col['nulls'] %}
										<li>{{_("There is missing data in this column")}}</li>
									{% endif %}
									{% if 'freq' in col %}
										<li>{{col['freq']|round(2)}}</li>
									{% endif %}
									{% if 'len' in col %}
										<li>{{_("The longest string is <em>%d</em> characters" % col['len']) }}</li>
									{% endif %}
								</ul>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	{% endfor %}
	</div>
	<div class="row">
		<div class="col-md-12">
			{# share() #}
		</div>
	</div>
</div>
{% endblock %}

{% block custom_footer %}
	{{ what_next("Lorem ipsum dolor sit amet, consectetur adipiscing elit. Donec a diam lectus. Sed sit amet ipsum mauris. Maecenas congue ligula ac quam viverra nec consectetur ante hendrerit. Donec et mollis dolor.") }}
{% endblock %}

{% block results_scripts %}
<script type="text/javascript" src="https://cdn.rawgit.com/nnattawat/flip/v1.0.18/dist/jquery.flip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/d3.layout.cloud.js') }}" charset="utf-8"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/lib/highcharts.js') }}"></script>
<script type="text/javascript">

// Uncomment to enable drag & drop
/*Sortable.create(sortableRow, {
  handle: '.dragHandle',
  animation: 150,
  ghostClass: 'ghost'
});*/

// Card flipping
$('.card').flip();

// Card navigation
$('#card-position-reference').affix({
	offset: {
		top: $('#intro').outerHeight(true) + $('.navbar').outerHeight(true)
	}
});

$(function () {

	Highcharts.theme = {
		colors: ['#fff'],
		chart: {
			backgroundColor: 'none',
			// width: 275,
			height: 300
		},
		xAxis: {
			gridLineColor: '#fff',
			lineColor: '#fff',
			tickColor: '#fff',
			labels: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			},
			title: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			}
		},
		yAxis: {
			gridLineColor: 'transparent',
			lineColor: '#fff',
			tickColor: '#fff',
			labels: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			},
			title: {
				style: {
					color: '#fff',
					font: '14px HalisGR-Book',
					fontWeight: 'bold'
				}
			}
		}
	}

	var highchartsOptions = Highcharts.setOptions(Highcharts.theme);

{% for c in range(column_count) %}
	{% set col=results[index]['columns'][c] %}
	{% set dname=col['display_type_name'] %}

	{% if not 'word_counts' in col %}

		{% if 'text' in dname or 'numbers' in dname or 'dates' in dname or 'times' in dname or 'dates and times' in dname %}
			$('#card-chart-{{ c }}').highcharts({
				title: {
					text: null
				},
				tooltip: {
					enabled: false
				},
				{% if 'text' in dname or 'numbers' in dname %}
					chart: {
						type: 'column'
					},
				{% endif %}
				xAxis: {
					title: {
						text:
						{% if 'text' in dname %}
						_('Categories')
						{% elif 'numbers' in dname %}
						_('Counts')
						{% elif 'dates' %}
						_('Dates')
						{% elif 'times' %}
						_('Times')
						{% elif 'dates and times' %}
						_('Dates and times')
						{% else %}
						_('Undefined')
						{% endif %}
					},
					categories: [
						{% if 'most_freq_values' in col %}
							{{ get_most_freq(col['most_freq_values'], 'value', dname) }}
						{% endif %}
					],
					plotLines: [{
						color: '#fff'
					}]
				},
				yAxis: {
					title: {
						text: _('# of rows')
					},
					plotLines: [{
						color: '#fff'
					}]
				},
				plotOptions: {
				    column: {
				        pointPadding: 0,
				        borderWidth: 0,
				        groupPadding: 0,
				        shadow: false
				    }
				},
				series: [{
					data: [
						{% if 'most_freq_values' in col %}
							{{ get_most_freq(col['most_freq_values'], 'count', dname) }}
						{% endif %}
					],
					showInLegend: false,
					marker: {
						states: {
							hover: {
								enabled: false
							}
						}
					}
				}],
				credits: {
					enabled: false
				}
			});
		{% endif %}
	
	{% else %}

		// Word cloud
		var data = [
		{% for word in col['word_counts'][0] | batch(50) | first %}
			{ text: "{{ word[0]|safe }}", size: {{ word[1]|float }} },
		{% endfor %}
		];

		var width = $('#card-chart-{{ c }}').width();

		var maxScore = Math.max.apply(Math, data.map(function(o) {return o.size;}));
		var fontSizeScale = d3.scale.linear()
			.domain([0, maxScore])
			.range([8, 70]); 

		var fill = d3.scale.category20();
		var layout = d3.layout.cloud()
			.size([width, 300])
			.words(data)
			.padding(6)
			.rotate(function () { return 0; })
			.fontSize(function(d) { return fontSizeScale(d.size); });

		layout.start();

		d3.select('#card-chart-{{ c }}').append('svg')
			.attr('width', layout.size()[0])
			.attr('height', layout.size()[1])
		.append('g')
			.attr('transform', 'translate(' + layout.size()[0] / 2 + ',' + layout.size()[1] / 2 + ')')
		.selectAll('text')
			.data(data)
		.enter().append('text')
			.classed('cloud-text', true)
			.style('font-size', function(d) { return d.size + 'px'; })
			.style('font-family', function (d) { return d.size > 30 ? 'HalisGR-Medium' : 'HalisGR-Book'; })
			.attr('text-anchor', 'middle')
			.attr('fill', '#fff')
			.attr('transform', function (d) {
				return 'translate(' + [d.x, d.y] + ')rotate(' + d.rotate + ')';
			})
			.text(function (d) { return d.text; });

	{% endif %}

{% endfor %}

});

</script>
{% endblock %}

{% macro get_most_freq(most_freq_values, key, displayName) %}
	{% set is_string = 'text' in displayName %}
	{% for val in most_freq_values %}
		{% if 'value' in key %}
			{% if is_string %}
				"{{ val[key]|string }}",
			{% else %}
				{{ val[key]|replace('_', '.') }},
			{% endif %}
		{% else %}
			{{ val[key] }},
		{% endif %}
	{% endfor %}
{% endmacro %}
